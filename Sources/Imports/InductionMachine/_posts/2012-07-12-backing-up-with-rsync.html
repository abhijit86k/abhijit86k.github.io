---
layout: post
title: Backing Up with Rsync
date: '2012-07-12T14:39:00.002+05:30'
author: Abhijit Kshirsagar
tags: 
modified_time: '2012-07-17T12:02:15.501+05:30'
---

<div dir="ltr" style="text-align: left;" trbidi="on">There's always a moment of butterflies when your machine hangs, or doesn't&nbsp; boot up, or shows some cryptic message and dies. In the few minutes following my last such catastrophe, I berated myself for not taking regular backups on an external drive. Then I started to look at trying to recover the data using a <a href="http://en.wikipedia.org/wiki/Live_CD" target="_blank">live CD</a>. When I finally got the new OS going I decided the first thing to do was to set up a system to silently backup the system every once in a while, either to a USB hard drive or to a network drive. So I wrote a script to do this using rsync. The script is as follows, with explanations for each line...<br /><br /><a name='more'></a><br /><br /><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">#!/bin/bash</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#This tells the shell that this is a bash script</span></span><br /><span style="font-size: x-small;">#Script to backup the contents of my desktop machine to an external device<br />#identified by the following UUID:<br /><br />TARGET_UUID=84f15456-ce64-52be-c488-e88125e623a30;</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#This line defines which device is to be used as the backup device. For example, #backups must be made ONLY to a specific hard disk, not just any device that may #be plugged in</span></span><span style="color: #38761d; font-size: x-small;">. </span><span style="color: #38761d; font-size: x-small;">If a new backup device is to be used, change the UUID!</span><span style="font-size: x-small;"><span style="color: #38761d;"> If a new #backup device is to be used, change the UUID!</span></span><br /><span style="font-size: x-small;"><span style="color: #38761d;"># </span><br /><br />MAINLOG=/home/someuser/serverbackup.log</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#Set a variable with the name of a main log file. This will contain broad info, #like date of last backup and success or failure stats.</span></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">VERBOSELOG=/home/</span><span style="font-size: x-small;">someuser</span><span style="font-size: x-small;">/backupdetails.log</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#This file contains the details of what files were backed up, how much time it #took, etc etc.</span></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">BACKUPTARGET=/home/</span><span style="font-size: x-small;">someuser</span><span style="font-size: x-small;">/BACKUP/</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#This is the location where the backup drive will be mounted. If the drive is #mounted in the same location.</span></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#NOTE: USB devices usually get automounted on insertion in Ubuntu. If this is the #case, you may want to either&nbsp;</span></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;"># 1. disable automount for that particular device,</span></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;"># 2. Mount to a fixed location always</span></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;"># 3. allow automount and then figure out at run time if the device is mounted,</span></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;"># and where. Naturally this is the most robust approach but my script assumes automount has been disabled for my drive.</span></span><br /><span style="font-size: x-small;"><br />#Status Variable, used for logging also<br />ERROR=0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #0:Success , Non-Zero:Failure(s)</span><span style="font-size: x-small;"><span style="color: #38761d;">#This is a status variable which will keep accumulating the error values</span></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><br /><span style="font-size: x-small;">#Alias for RSync:<br />alias rsync='rsync -az --delete-after'<br />shopt -s expand_aliases</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#I don't want to be typing out the full rsync command, so I make an alias for it. #Note that when a bash script is executed, NONE of the environment variables or #aliases from the original shell are available to it. It runs in a 'fresh and #clean' shell, so to speak.&nbsp;</span></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#Moreover, even if an alias is defined, it DOES not get expanded unless explicitly #told to do so using the "shopt" command</span></span><br /><br /><span style="font-size: x-small;"><span style="color: #38761d;">#Rsync Options:&nbsp;</span></span><br /><span style="font-size: x-small;"><span style="color: #38761d;">#-az archive mode: preserve directory structure, permissions, etc</span></span><br /><span style="font-size: x-small;"><span style="color: #38761d;">#--delete-after: delete files from the target that are no longer on the source</span></span><br /><span style="font-size: x-small;"><span style="color: #38761d;">#IF your target is an NTFS formatted disk, or a drive on a windows machine,</span></span><br /><span style="font-size: x-small;"><span style="color: #38761d;"># then links cannot be copied. So use the --no-l (no links) option also. </span></span><br /><span style="font-size: x-small;"><br /># The date of the lastbackup is stored in a file called <br /># lastdiskbackup</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#A file with the date of the last backup is kept. This prevents us from making a #backup when a very recent backup has already been made. This is VERY useful when #the backups are to be made automatically via a cron job.</span></span><br /><span style="font-size: x-small;"><br />if [ -e lastdiskbackup ]; then<br /><span style="color: #38761d;">#If it does not exist then create it</span><br />echo "";</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#Just a dummy statement</span></span><br /><span style="font-size: x-small;">else<br />date --date="10 years ago" &gt; lastdiskbackup;<br />fi</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><br /></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;"><br /></span></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#Calculate when the last backup was made</span></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><br /><span style="font-size: x-small;">DAYS_SINCE_LAST_BACKUP=$(echo $"(( $(date +%s) - $(date --date="`cat lastdiskbackup`" +%s) ))/(60*60*24)"|bc)</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><br /></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#If the last backup to disk was done today, then don't backup again.</span><br />if [ $DAYS_SINCE_LAST_BACKUP = 0 ]; then<br />echo "Last backup was just $DAYS_SINCE_LAST_BACKUP ago. Quitting"<br /><span style="color: #38761d;">#Exit from the script</span> </span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">exit 0;<br />fi</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><br /></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">echo "*********************************************************************" &gt;&gt; $MAINLOG<br />echo "`date`" &gt;&gt; $MAINLOG<br />echo "Backing up to Disk" &gt;&gt; $MAINLOG<br />echo "" &gt;&gt; $MAINLOG</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#Pretty print to the main log</span></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><br /></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><br />echo "*********************************************************************" &gt;&gt; $VERBOSELOG<br />echo `date` &gt;&gt; $VERBOSELOG<br />echo "" &gt;&gt; $VERBOSELOG</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;">#Pretty print to the verbose log</span></span><br /><span style="font-size: x-small;"><br />#********************************************************************<br /><span style="color: #38761d;">#Mount Local Drive for backup&nbsp;&nbsp; </span><br />if [ -e /dev/disk/by-uuid/$TARGET_UUID ] ; then<br />echo "Backup Drive Found..."&gt;&gt; $VERBOSELOG<br />else<br />echo "Fatal: Disk Not found" &gt;&gt; $MAINLOG<br />exit 0<br />fi<br /><br />echo "Mounting Backup Drive..."&gt;&gt; $VERBOSELOG<br />mount /dev/disk/by-uuid/$TARGET_UUID /some/folder/ &amp;&gt;&gt; $VERBOSELOG<br />echo "" &gt;&gt; $VERBOSELOG<br />echo "" &gt;&gt; $VERBOSELOG</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"></span></div><div style="color: #38761d; font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div style="color: #38761d; font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div style="color: #38761d; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">#I put this to check for the existence of a certain file. In case there is&nbsp;</span></div><div style="color: #38761d; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">#a problem with the mount, or the wrong drive gets mounted this is&nbsp;</span></div><div style="color: #38761d; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">#still a fall-back check to make sure that the expected drive has been&nbsp;</span></div><div style="color: #38761d; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">#mounted in the right place.</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><br /><span style="font-size: x-small;">if [ -e /some/folder/testfile ] ; thenecho "" &gt; /dev/null;<br />else<br />echo "Fatal: Backup Location not found" &gt;&gt; $MAINLOG<br />exit 0<br />fi</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><br /></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;">#--------------------------------------------------------------------<br />#BACKUPS<br />#--------------------------------------------------------------------</span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-size: x-small;"><span style="color: #38761d;"># The actual backups...</span></span><br /><span style="font-size: x-small;"><span style="color: #38761d;"># make as many copies of this snippet, changing the arguments to rsync to suit</span></span><br /><span style="font-size: x-small;"><span style="color: #38761d;"># your requirements. You should be backing up only really important stuff -&nbsp;</span></span><br /><span style="font-size: x-small;"><span style="color: #38761d;"># if you back up your entire /home you may end up backing up just a lot&nbsp;</span></span><br /><span style="font-size: x-small;"><span style="color: #38761d;"># of garbage that you cannot or will never use.</span></span></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"></div><div style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="color: purple; font-size: x-small;">echo "Backing Up HOME" &gt;&gt; $VERBOSELOG<br />echo "--------------" &gt;&gt; $VERBOSELOG<br />rsync /home/myuser/ $DEST &gt;&gt; $VERBOSELOG<br />ERROR=$[$ERROR+$?];<br />echo "" &gt;&gt; $VERBOSELOG<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">#--------------------------------------------------------------------</span></span><br /><span style="color: purple; font-size: x-small;"></span><br /><span style="color: purple; font-size: x-small;"><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="color: #38761d; font-family: &quot;Courier New&quot;,Courier,monospace;"># Now we are done with the backing up; remove (unmount)</span></span><br /><span style="color: purple; font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="color: #38761d;"># the backup disk</span></span></span><br /><br /><span style="color: purple; font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">echo "Unmounting backup drive:" &gt;&gt; $VERBOSELOG</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">umount $BACKUPTARGET &gt;&gt; $VERBOSELOG</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">if [ $ERROR = 0 ]; then</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">echo "Successfully Completed backup" &gt;&gt; $MAINLOG</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">else</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">echo "Backup Unsuccessful. There were errors. [Code: $ERROR]" &gt;&gt; $MAINLOG</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">fi</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><br style="color: #38761d; font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="color: #38761d; font-family: &quot;Courier New&quot;,Courier,monospace;">#Change date in the file to reflect this backup</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">date &gt; lastdiskbackup</span></span><br /><br /><div style="text-align: left;"><span style="color: purple; font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-family: Times,&quot;Times New Roman&quot;,serif; font-size: small;"></span><span style="font-family: Times,&quot;Times New Roman&quot;,serif;"> </span></span></span></div></div><div dir="ltr" style="text-align: left;" trbidi="on">Now for the last part of the exercise: creating a launcher. Until Unity and GNOME came along, things were fine - a right click on the desktop bar would let you add a launcher. Now in unity you need to do something extra - create a file in <span style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;">/usr/share/applications</span> as explained <a href="http://askubuntu.com/a/137228" target="_blank">here</a>. Not happy with the icon? Select one from&nbsp;<span style="color: purple;"></span><span style="color: purple; font-family: &quot;Courier New&quot;,Courier,monospace;">/usr/share/icons</span> and type in the file name in the field for icon.<br /><br /><br /></div></div>