---
layout: post
title: Automounting Network partitions
date: '2012-07-16T17:26:00.000+05:30'
author: Abhijit Kshirsagar
tags:
- Ubuntu
- automount
- cifs
modified_time: '2012-07-16T17:26:19.697+05:30'
---

<div dir="ltr" style="text-align: left;" trbidi="on">If you have network drives that you would like to be auto-mounted on startup on your Linux box, then the obvious way to do this seems to be to put the appropriate line in <span style="color: blue; font-family: &quot;Courier New&quot;,Courier,monospace;">/etc/fstab</span>. (Note that for Windows shares, the appropriate packages have to be installed - samba and smbfs).<br /><br />However, if the fstab is executed before the network comes up, you have a problem - the mount will fail. The workaround is to either<br /><ol style="text-align: left;"><li>not do auto-mount, OR </li><li>delay the mount till the network is up OR</li><li>to use a program written specifically for this situation - <a href="https://help.ubuntu.com/community/Autofs" target="_blank">Autofs.</a>&nbsp; </li></ol><br /><a name='more'></a>Despite a lot of struggling, autofs did not work, so went to option #2. The scheme is simple, after the system boots I run a small script to check if the network is up (by pinging a known server). I keep trying at fixed intervals till the network is found to be up, then I mount the remote drives. Note that corresponding entries have been made in <span style="color: blue; font-family: &quot;Courier New&quot;,Courier,monospace;">/etc/fstab</span>.<h4 style="text-align: left;">1. Create entries in fstab:</h4>The <span style="color: blue;">fstab</span> entries look like this:<br /> <blockquote class="tr_bq">   <span style="color: #38761d; font-size: x-small;"><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">#Bhaskara</span><br style="font-family: &quot;Courier New&quot;,Courier,monospace;" />      <span style="font-family: &quot;Courier New&quot;,Courier,monospace;">//server/folder  /mount-pointhome cifs  defaults,noauto,locale=en_IN,uid=networkusername,password=networkpasswd,gid=localgroup,user=localuser  0 0</span></span></span><br /> </blockquote>The "noauto" option ensures that these will not get mounted along with the local drives at bootup.<br /><br /><h4 style="text-align: left;">2. Create the script </h4>Now to create a script which, when called, will check if the network is up, and if it is, will mount the drive. This script is saved as (in this example):<br /><b><span style="color: blue; font-family: &quot;Courier New&quot;,Courier,monospace;">/home/myuser/bin/mount_drives</span>&nbsp;</b><br />Ensure that you make this file executable.<br /> <blockquote class="tr_bq">   <span style="color: #38761d; font-size: x-small;"><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="color: purple;">#!/bin/bash</span><br />MAX_TRIES=60; <span style="color: purple;"># Defines the number of times to atempt</span><br />DELAY=5;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: purple;">#Delay between successive attempt</span><br /><br /><span style="color: purple;">#A Variable to keep track of network status:</span><br style="color: purple;" /><span style="color: purple;"># 0: Working</span><br style="color: purple;" /><span style="color: purple;"># non-zero: not working</span><br style="color: purple;" />NETSTAT=1;<br /><br /><span style="color: purple;">#Number of tries made:</span><br />COUNT=0;<br /><br /><span style="color: purple;">#Keep trying to reach the network:</span><br style="color: purple;" />while [ $NETSTAT != 0 ]; do<br />ping -A -c 5 server<br /><br /><span style="color: purple;">#Get return value for ping</span><br />NETSTAT=$?<br /><br /><span style="color: purple;">#Increment count value</span><br /><br />COUNT=$[$COUNT+1]<br /><br /><span style="color: purple;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #If max no. of tries exceeded then quit</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if [ $COUNT = $MAX_TRIES ]; then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit 1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fi<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="color: #38761d; font-size: x-small;"><span style="font-size: x-small;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="color: purple;"></span>if [ $NETSTAT != 0 ]; then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sleep $DELAY<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fi<br />done<br /><br />sudo mount //server/folder</span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"></span></span></span></blockquote><blockquote class="tr_bq"> </blockquote>This script will attempt to reach the server (by ping) every DELAY seconds, and will try a maximum of MAX_TRIES number of times. <br />Now the only thing left to do is to:<br /><h4 style="text-align: left;">3. Run this script at every bootup.</h4>To do this, simply add a line to the end of /etc/init.d/rc.local:<br /><br /><span style="color: #38761d; font-family: &quot;Courier New&quot;,Courier,monospace; font-size: x-small;">/bin/bash /home/myuser/bin/mount_drives </span><br /><br /><br /><br /><br /></div>